"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2415],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>v});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),l=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=l(e.components);return a.createElement(o.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,o=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),d=l(t),m=r,v=d["".concat(o,".").concat(m)]||d[m]||u[m]||s;return t?a.createElement(v,i(i({ref:n},p),{},{components:t})):a.createElement(v,i({ref:n},p))}));function v(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,i=new Array(s);i[0]=m;var c={};for(var o in n)hasOwnProperty.call(n,o)&&(c[o]=n[o]);c.originalType=e,c[d]="string"==typeof e?e:r,i[1]=c;for(var l=2;l<s;l++)i[l]=t[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},7020:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var a=t(7462),r=(t(7294),t(3905));const s={sidebar_position:20,title:"Package Service"},i="What is Package Service?",c={unversionedId:"developer/service/package-service",id:"developer/service/package-service",title:"Package Service",description:"The Steedos Platform is based on the Moleculer microservices architecture, where each package is a Moleculer Service. You can define actions, methods, and subscribe to events in the service.",source:"@site/docs/developer/service/package-service.md",sourceDirName:"developer/service",slug:"/developer/service/package-service",permalink:"/developer/service/package-service",draft:!1,editUrl:"https://github.com/steedos/steedos-docs/tree/master/docs/developer/service/package-service.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{sidebar_position:20,title:"Package Service"},sidebar:"developer",previous:{title:"Overview",permalink:"/developer/service/overview"},next:{title:"REST API",permalink:"/developer/service/action-api"}},o={},l=[{value:"package.service.js",id:"packageservicejs",level:2},{value:"namespace",id:"namespace",level:3},{value:"mixins",id:"mixins",level:3},{value:"dependencies",id:"dependencies",level:3},{value:"Actions",id:"actions",level:2},{value:"Call services",id:"call-services",level:2},{value:"Syntax",id:"syntax",level:3},{value:"REST API",id:"rest-api",level:2},{value:"Triggers",id:"triggers",level:2},{value:"Events",id:"events",level:2},{value:"Subscribe to events",id:"subscribe-to-events",level:3}],p={toc:l},d="wrapper";function u(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"what-is-package-service"},"What is Package Service?"),(0,r.kt)("p",null,"The Steedos Platform is based on the Moleculer microservices architecture, where each package is a ",(0,r.kt)("a",{parentName:"p",href:"https://moleculer.services/docs/0.14/services"},"Moleculer Service"),". You can define actions, methods, and subscribe to events in the service. "),(0,r.kt)("h2",{id:"packageservicejs"},"package.service.js"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"package.service.js")," in the root directory of the steedos package is the loading entry for the package microservice."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const packageJSON = require('./package.json');\n\nmodule.exports = {\n  name: packageJSON.name,\n  namespace: \"steedos\",\n\n  /*\n    After mixin @steedos/service-package-loader, the package service will \n    automatically scan and load metadata files from subfolders upon startup. \n  */\n  mixins: [require('@steedos/service-package-loader')],\n\n  metadata: {\n    $package: {\n      name: packageJSON.name,\n      version: packageJSON.version,\n      path: __dirname,\n      isPackage: true\n    }\n  },\n\n  /**\n   * Settings\n   */\n  settings: {\n  },\n\n  /**\n   * Dependencies\n   */\n  dependencies: [],\n\n  /**\n   * Actions\n   */\n  actions: {\n\n  },\n\n  /**\n   * Events\n   */\n  events: {\n\n    },\n  /**\n   * Methods\n   */\n  methods: {\n  },\n\n  /**\n   * Service created lifecycle event handler\n   */\n  async created() {\n  },\n\n  /**\n     * Service started lifecycle event handler\n     */\n  async started() {\n  },\n\n  /**\n   * Service stopped lifecycle event handler\n   */\n  async stopped() {\n  }\n};\n")),(0,r.kt)("h3",{id:"namespace"},"namespace"),(0,r.kt)("p",null,"Namespace of nodes to segment your nodes on the same network.\nMust be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"steedos"),"."),(0,r.kt)("h3",{id:"mixins"},"mixins"),(0,r.kt)("p",null,"Mixins are a flexible way to distribute reusable functionalities for Moleculer services. The Service constructor merges these mixins with the current schema. When a service uses mixins, all properties present in the mixin will be \u201cmixed\u201d into the current service."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"After mixin ",(0,r.kt)("inlineCode",{parentName:"p"},"@steedos/service-package-loader"),", the package service will automatically scan and load metadata files from subfolders upon startup. ")),(0,r.kt)("h3",{id:"dependencies"},"dependencies"),(0,r.kt)("p",null,"If your service depends on other services, use the dependencies property in the schema. The service waits for dependent services before calls the started lifecycle event handler."),(0,r.kt)("p",null,"If the package you are developing depends on metadata from another package, you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"dependencies")," to control the loading order of the packages. For example, if the contract management package relies on metadata from the master data package, you can define it as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'module.exports = {\n  name: "@steedos-labs/contract",\n  dependencies: ["@steedos-labs/master"],\n}\n')),(0,r.kt)("h2",{id:"actions"},"Actions"),(0,r.kt)("p",null,"The actions are the callable/public methods of the service. The action calling represents a remote-procedure-call (RPC). It has request parameters & returns response, like a HTTP request. For more information check the ",(0,r.kt)("a",{parentName:"p",href:"https://moleculer.services/docs/0.14/actions"},"Moleculer Actions")," documentation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'  actions: {\n    multi: {\n      cache: false,\n      params: {\n        a: "number",\n        b: "number"\n      },\n      handler(ctx) {\n        if (!ctx.action.cache)\n          return Number(ctx.params.a) * Number(ctx.params.b);\n      }\n    }\n  }\n')),(0,r.kt)("h2",{id:"call-services"},"Call services"),(0,r.kt)("p",null,"To call a service use the ",(0,r.kt)("inlineCode",{parentName:"p"},"broker.call")," method. The broker looks for the service (and a node) which has the given action and call it. The function returns a ",(0,r.kt)("inlineCode",{parentName:"p"},"Promise"),"."),(0,r.kt)("h3",{id:"syntax"},"Syntax"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const res = await broker.call(actionName, params, opts);\n")),(0,r.kt)("h2",{id:"rest-api"},"REST API"),(0,r.kt)("p",null,"Steedos comes with a built-in ",(0,r.kt)("a",{parentName:"p",href:"https://moleculer.services/docs/0.14/moleculer-web"},"API Gateway"),", it can publish your services as RESTful APIs. "),(0,r.kt)("p",null,"This way, your action function can be accessed directly using an HTTP request, without the need to connect to the microservices network."),(0,r.kt)("p",null,"You can publish an action as a RESTful API by specifying the ",(0,r.kt)("inlineCode",{parentName:"p"},"rest")," parameter.  "),(0,r.kt)("p",null,"For more information check the ",(0,r.kt)("a",{parentName:"p",href:"./action-api"},"REST API")," documentation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"  actions: {\n    hello: {\n      rest: { method: 'GET', path: '/hello/:name' },\n      handler(ctx) {\n        return {\n          data: 'Welcome ' + ctx.params.name\n        }\n      }\n    },\n  }\n")),(0,r.kt)("h2",{id:"triggers"},"Triggers"),(0,r.kt)("p",null,"By writing triggers, you can automatically trigger a piece of server-side code before and after record creation, deletion, and changes, achieving personalized data validation and processing."),(0,r.kt)("p",null,"You can define an action and add a ",(0,r.kt)("inlineCode",{parentName:"p"},"trigger")," parameter to it."),(0,r.kt)("p",null,"For more information check the ",(0,r.kt)("a",{parentName:"p",href:"./action-trigger"},"Trigger")," documentation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"  actions: {\n    spaceUsersBeforeUpdate: {\n      trigger: { \n        listenTo: 'space_users', \n        when: ['beforeInsert', 'beforeUpdate']\n      },\n      async handler(ctx) {\n        this.broker.logger.debug('spaceUsersBeforeUpdate', ctx)\n      }   \n    }\n  }\n")),(0,r.kt)("h2",{id:"events"},"Events"),(0,r.kt)("p",null,"You can subscribe to events under the events key. For more information check the ",(0,r.kt)("a",{parentName:"p",href:"./moleculer/events"},"Events")," documentation."),(0,r.kt)("h3",{id:"subscribe-to-events"},"Subscribe to events"),(0,r.kt)("p",null,"Context-based event handler & emit a nested event."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'module.exports = {\n    name: "@steedos-labs/project",\n    events: {\n        "@space_users.inserted"(ctx) {\n            console.log("Payload:", ctx.params);\n            console.log("Sender:", ctx.nodeID);\n            console.log("Metadata:", ctx.meta);\n            console.log("The called event name:", ctx.eventName);\n\n            ctx.emit("users.changed", { data: ctx.params.doc });\n        },\n\n        "@space_users.deleted": {\n            handler(ctx) {\n                console.log(`${this.broker.nodeID}:${this.fullName}: Event \'${ctx.eventName}\' received. Payload:`, ctx.params, ctx.meta);\n            }\n        }\n    }\n};\n')))}u.isMDXComponent=!0}}]);