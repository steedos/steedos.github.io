"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4713],{65200:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>p});var i=t(74848),s=t(28453);const o={title:"SSO API",description:"\u901a\u8fc7jwt\u5b9e\u73b0\u5916\u63a5\u5e94\u7528\u4e0e\u9b54\u65b9\u5e73\u53f0\u53cc\u5411\u5355\u70b9\u767b\u5f55\u3002"},r=void 0,a={id:"developer/integration/api-jwt-sso",title:"SSO API",description:"\u901a\u8fc7jwt\u5b9e\u73b0\u5916\u63a5\u5e94\u7528\u4e0e\u9b54\u65b9\u5e73\u53f0\u53cc\u5411\u5355\u70b9\u767b\u5f55\u3002",source:"@site/docs/developer/integration/api-jwt-sso.mdx",sourceDirName:"developer/integration",slug:"/developer/integration/api-jwt-sso",permalink:"/developer/integration/api-jwt-sso",draft:!1,unlisted:!1,editUrl:"https://github.com/steedos/steedos-docs/tree/master/docs/developer/integration/api-jwt-sso.mdx",tags:[],version:"current",frontMatter:{title:"SSO API",description:"\u901a\u8fc7jwt\u5b9e\u73b0\u5916\u63a5\u5e94\u7528\u4e0e\u9b54\u65b9\u5e73\u53f0\u53cc\u5411\u5355\u70b9\u767b\u5f55\u3002"},sidebar:"developer",previous:{title:"Integration",permalink:"/developer/integration/"},next:{title:"Node-Red",permalink:"/developer/integration/node-red"}},l={},p=[{value:"Logging into the Steedos from external applications.",id:"logging-into-the-steedos-from-external-applications",level:2},{value:"Preparation",id:"preparation",level:3},{value:"Next",id:"next",level:3},{value:"Example",id:"example",level:3},{value:"Login to External Applications via Steedos",id:"login-to-external-applications-via-steedos",level:2},{value:"Process Description",id:"process-description",level:3},{value:"Example",id:"example-1",level:3}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"logging-into-the-steedos-from-external-applications",children:"Logging into the Steedos from external applications."}),"\n",(0,i.jsx)(n.h3,{id:"preparation",children:"Preparation"}),"\n",(0,i.jsx)(n.p,{children:"1\u3001 Steedos needs to be configured with environment variables enabled for single sign-on. Add the following to the .env.local file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-env",children:"# JWT SSO\nSTEEDOS_IDENTITY_JWT_ENABLED=true\n"})}),"\n",(0,i.jsx)(n.h3,{id:"next",children:"Next"}),"\n",(0,i.jsxs)(n.p,{children:["1\u3001The external application generates a JWT in the custom server interface.\n2\u3001The external application redirects to Steedos interface using the following GET request: ",(0,i.jsx)(n.code,{children:"{root_url}/accounts/jwt/login?t={jwt}&redirect={redirectURL}"})," to achieve single sign-on."]}),"\n",(0,i.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,i.jsx)(n.p,{children:"1\u3001To create a new application in Steedos, you need to specify an API name (e.g. finance) and an API key (e.g. app_api_secret)."}),"\n",(0,i.jsx)(n.p,{children:"2\u3001The external application's frontend button calls the custom API (e.g. GET /api/get/token) to generate a JWT."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"module.exports = {\n    sso: function (object_name, record_id) {\n        const getTokenURL = '/api/get/token'; \n\n        const result = Steedos.authRequest(getTokenURL, {\n            type: 'GET',\n            async: false,\n            contentType: 'application/json'\n        });\n\n        const token = result.token;\n        const PLATFORM_ROOT_URL = 'https://5000-steedos-steedosprojectt-5apf195eq37.ws-us77.gitpod.io' \n        window.open(`${PLATFORM_ROOT_URL}/accounts/jwt/login?t=${token}&redirect=${PLATFORM_ROOT_URL}`, '_blank') \n\n    },\n    ssoVisible: function () {\n        return true\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"3\u3001A custom server-side API needs to be implemented."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const express = require(\"express\");\nconst router = express.Router();\nconst core = require('@steedos/core');\nconst jwt = require('jsonwebtoken');\n\nrouter.get('/api/get/token', core.requireAuthentication, async function (req, res) {\n    const userSession = req.user;\n\n    var secret = 'app_api_secret' \n    var options = { expiresIn: 30 } \n    var token = jwt.sign({\n        profile: {\n            email: userSession.email \n        },\n        app_code: 'finance' \n    }, secret, options);\n\n    res.status(200).send({\n        token: token\n    });\n});\nexports.default = router;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"login-to-external-applications-via-steedos",children:"Login to External Applications via Steedos"}),"\n",(0,i.jsx)(n.h3,{id:"process-description",children:"Process Description"}),"\n",(0,i.jsx)(n.p,{children:"1\u3001Create a new application in Steedos, specifying the external link and API key."}),"\n",(0,i.jsx)(n.p,{children:'2\u3001Click on the external application in the launcher and redirect to the external link, passing the "t" parameter in the URL.'}),"\n",(0,i.jsx)(n.p,{children:'3\u3001The external application parses the "t" parameter and redirects the user to the application.'}),"\n",(0,i.jsx)(n.h3,{id:"example-1",children:"Example"}),"\n",(0,i.jsxs)(n.p,{children:["1\u3001Create a new application in Steedos and specify the external link (e.g. GET ",(0,i.jsx)(n.a,{href:"https://5000-steedos-steedosprojectt-5apf195eq37.ws-us77.gitpod.io/api/sso",children:"https://5000-steedos-steedosprojectt-5apf195eq37.ws-us77.gitpod.io/api/sso"}),") and API key (e.g. app_api_secret)."]}),"\n",(0,i.jsx)(n.p,{children:"2\u3001In the application launcher, click on the external application and you will be redirected to the external link."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"https://5000-steedos-steedosprojectt-5apf195eq37.ws-us77.gitpod.io/api/sso?t=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvYmplY3RfbmFtZSI6InNwYWNlX3VzZXJzIiwiZG9jIjp7Il9pZCI6IkFGTkVuQ3hiU29HRWc0b2NmIiwibmFtZSI6Inh4eCIsInVzZXJuYW1lIjoieHh4eHh4IiwiZW1haWwiOiJzQHMuY29tIn0sImlhdCI6MTY2OTI2NjA0NiwiZXhwIjoxNjY5MjY5NjQ2fQ.qeld2kTl5zjLGjCWgk3cb6UPEPlqmzMaME20mo_t-t4\n"})}),"\n",(0,i.jsx)(n.p,{children:"3\u3001To parse the token in the external application"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const express = require(\"express\");\nconst router = express.Router();\nconst jwt = require('jsonwebtoken')\n\nrouter.get('/api/sso', async function (req, res) {\n    console.log(req.query)\n    // {\n    //     t: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvYmplY3RfbmFtZSI6InNwYWNlX3VzZXJzIiwiZG9jIjp7Il9pZCI6IkFGTkVuQ3hiU29HRWc0b2NmIiwibmFtZSI6Inh4eCIsInVzZXJuYW1lIjoieHh4eHh4IiwiZW1haWwiOiJzQHMuY29tIn0sImlhdCI6MTY2OTI2NjA0NiwiZXhwIjoxNjY5MjY5NjQ2fQ.qeld2kTl5zjLGjCWgk3cb6UPEPlqmzMaME20mo_t-t4'\n    // }\n    const payload = jwt.verify(req.query.t, 'app_api_secret') \n    console.log(payload)\n    // {\n    //     profile: {\n    //         name: 'xxx',\n    //         username: 'xxxxxx',\n    //         email: 's@s.com'\n    //     },\n    //     iat: 1669266046,\n    //     exp: 1669269646\n    // }\n\n    res.status(200).send({ message: 'router ok' });\n});\nexports.default = router;\n"})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(96540);const s={},o=i.createContext(s);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);